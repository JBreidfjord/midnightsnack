{% extends "post.html" %}

{% block content %}
{{ super() }}
{% endblock content %}

{% block article %}
<div id="editable-article-content" class="editable-article-content">
    {{ super() }}
</div>
{% endblock article %}

{% block right_side_content %}
<div class="btn-group-vertical btn-group-sm position-fixed" id="editor-submit" role="group" aria-label="Editor button group">
    <button class="btn btn-outline-primary" id="start-edit">Edit Article</button>
    <button class="btn btn-outline-primary" id="submit-edit">Submit Changes</button>
    <button class="btn btn-outline-primary" id="commit-article">Finish</button>
</div>
{% endblock right_side_content %}

{% block scripts %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    $(document).ready(function(){
        function startEdit() {
            axios.get("/edit/{{ tmp_id }}")
            .then(function (response) {
                articleMd = response.data;
                document.getElementById("editable-article-content").innerHTML = (
                    `<div><pre><code class="nohighlight" id="editor-block" contenteditable>${articleMd}</code></pre></div>`
                );
            })
            .catch(function (error) {
                console.log(error);
            })
            .then(function () {
                console.log('Ran startEdit');
            });
        };
          
        function submitEdit() {
            articleMd = document.getElementById("editor-block").innerHTML;
            form = new FormData();
            form.append("article_md", articleMd);
            axios.post("/edit/{{ tmp_id }}", form, {
                headers: {
                    "Accept": "multipart/form-data",
                    "Content-Type": "multipart/form-data"
                }
            })
            .then(function (response) {
                articleDiv = document.getElementById("editable-article-content")
                articleDiv.innerHTML = response.data;
                hljs.highlightAll();
            })
            .catch(function (error) {
                console.log(error);
            });
        };

        function commitPost() {
            result = confirm("Are you sure?\nThis will commit the article.")
            if (result == true) {
                axios.post("/submit/{{ tmp_id }}")
                .then(function (response) {
                    console.log(response);
                    if (response.status == 200) {
                        window.location = response.data.url
                    }
                })
                .catch(function (error) {
                    console.log(error);
                    alert(error);
                });
            };
        };
        $("#start-edit").click(startEdit);
        $("#submit-edit").click(submitEdit);
        $("#commit-article").click(commitPost);
        $(document).on("keydown", "#editor-block", function(e){
            if(e.keyCode == 9){
                e.preventDefault();
                document.execCommand("insertHTML", false, "\u00a0\u00a0\u00a0\u00a0");
            }
        });
      });
</script>
{% endblock scripts %}